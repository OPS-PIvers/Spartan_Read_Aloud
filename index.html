<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      background-color: #f0f2f5;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 20px;
    }

    h1 {
      color: #333;
    }

    #login-container {
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      text-align: center;
      width: 100%;
      max-width: 400px;
    }

    #login-container h2 {
      margin-top: 0;
      margin-bottom: 20px;
      color: #1a73e8;
    }
    
    #login-error {
      color: #d93025;
      margin-bottom: 15px;
      min-height: 1.2em;
      text-align: left;
    }

    input[type="email"],
    input[type="password"] {
      width: calc(100% - 22px);
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 16px;
    }

    button {
      background-color: #1a73e8;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s;
      width: 100%;
    }

    button:hover {
      background-color: #155ab6;
    }
      button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    #viewer-container {
      width: 100%;
      max-width: 1200px;
      display: none;
      position: relative; 
      display: flex;
      flex-direction: row;
    }
    
    #status {
      margin: 20px 0;
      font-size: 1.1em;
      color: #555;
      min-height: 25px;
    }

    #pdf-container {
      border: 1px solid #ddd;
      background-color: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      position: relative; 
      flex-grow: 1;
    }
    
    #pdf-container canvas {
      display: block;
      margin: 0 auto 10px auto;
      max-width: 100%;
      height: auto;
    }

    #side-panel {
      width: 300px;
      margin-left: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 20px;
      max-height: 80vh;
      overflow-y: auto;
      position: sticky;
      top: 20px;
    }

    .side-panel-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      display: flex;
      align-items: center;
    }

    .side-panel-item:hover {
      background-color: #f0f2f5;
    }

    .side-panel-item.playing {
      background-color: #e8f0fe;
    }

    .play-icon {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%231a73e8"><path d="M8 5v14l11-7z"></path></svg>');
      background-size: contain;
      background-repeat: no-repeat;
    }

    .side-panel-item.playing .play-icon {
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%231a73e8"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>');
    }

  </style>
</head>

<body>
  <h1>Assessment Reader</h1>

  <div id="login-container">
    <h2>Student Login</h2>
    <div id="login-error"></div>
    <input type="email" id="email-input" placeholder="Enter your school email" autocomplete="email">
    <input type="password" id="password-input" placeholder="Enter the assessment password">
    <button id="load-button" onclick="loadAssessment()">Load Assessment</button>
  </div>

  <div id="viewer-container" style="display: none;">
    <div id="pdf-container">
      <!-- Canvases will be added here -->
    </div>
    <div id="side-panel">
      <!-- Audio chunks will be added here -->
    </div>
  </div>

  <script>
    const emailInput = document.getElementById('email-input');
    const passwordInput = document.getElementById('password-input');
    const loadButton = document.getElementById('load-button');
    const pdfContainer = document.getElementById('pdf-container');
    const loginContainer = document.getElementById('login-container');
    const viewerContainer = document.getElementById('viewer-container');
    const loginErrorDiv = document.getElementById('login-error');
    const sidePanel = document.getElementById('side-panel');
    
    let globalAudioPlayer = new Audio();
    let currentlyPlayingChunk = null;
    let serverChunks = [];

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';

    function loadAssessment() {
      loginErrorDiv.textContent = '';
      if (!emailInput.value || !passwordInput.value) {
        loginErrorDiv.textContent = 'Please enter both your email and the password.';
        return;
      }
      
      loginContainer.style.display = 'none';
      viewerContainer.style.display = 'flex';
      loadButton.disabled = true;

      google.script.run
        .withSuccessHandler(onPdfLoaded)
        .withFailureHandler(onPdfLoadError)
        .getAssessmentPdf(emailInput.value, passwordInput.value);
    }

    function onPdfLoaded(result) {
      if (result.error) {
        onPdfLoadError(result.error);
        return;
      }
      
      serverChunks = result.audioChunks;
      const pdfData = atob(result.pdfData);
      
      const loadingTask = pdfjsLib.getDocument({ data: pdfData });
      loadingTask.promise.then(pdfDocument => {
        
        pdfContainer.innerHTML = ''; // Clear container
        const pagePromises = [];
        for (let pageNum = 1; pageNum <= pdfDocument.numPages; pageNum++) {
          pagePromises.push(processPage(pdfDocument, pageNum));
        }
        
        Promise.all(pagePromises).then(() => {
            console.log("All pages rendered.");
            populateSidePanel();
        });

      }).catch(onPdfLoadError);
    }

    function processPage(pdfDocument, pageNum) {
      return pdfDocument.getPage(pageNum).then(page => {
        const viewport = page.getViewport({ scale: 1.5 });
        const canvas = document.createElement('canvas');
        canvas.id = 'page-' + pageNum;
        const context = canvas.getContext('2d');
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        pdfContainer.appendChild(canvas);
        
        const renderContext = {
          canvasContext: context,
          viewport: viewport
        };
        return page.render(renderContext).promise;
      });
    }

    function onPdfLoadError(error) {
      viewerContainer.style.display = 'none';
      loginContainer.style.display = 'block';
      loadButton.disabled = false;
      loginErrorDiv.textContent = 'Error: ' + error;
    }

    function populateSidePanel() {
      sidePanel.innerHTML = '';
      serverChunks.forEach((chunk, index) => {
        const item = document.createElement('div');
        item.className = 'side-panel-item';
        item.id = 'chunk-item-' + index;

        const playIcon = document.createElement('div');
        playIcon.className = 'play-icon';

        const text = document.createElement('div');
        text.textContent = getCleanedChunkText(chunk.text);

        item.appendChild(playIcon);
        item.appendChild(text);

        item.onclick = () => playAudio(chunk, index);
        sidePanel.appendChild(item);
      });
    }

    function getCleanedChunkText(text) {
      const words = text.trim().split(/\s+/);
      return words.slice(0, 8).join(' ') + (words.length > 8 ? '...' : '');
    }

    function playAudio(chunk, index) {
      const item = document.getElementById('chunk-item-' + index);

      if (currentlyPlayingChunk === chunk) {
        if (globalAudioPlayer.paused) {
          globalAudioPlayer.play();
          item.classList.add('playing');
        } else {
          globalAudioPlayer.pause();
          item.classList.remove('playing');
        }
        return;
      }

      // Stop currently playing and remove its 'playing' class
      if (currentlyPlayingChunk) {
        const oldIndex = serverChunks.indexOf(currentlyPlayingChunk);
        const oldItem = document.getElementById('chunk-item-' + oldIndex);
        if (oldItem) {
          oldItem.classList.remove('playing');
        }
      }

      globalAudioPlayer.pause();
      currentlyPlayingChunk = chunk;
      item.classList.add('playing');

      const fileIdMatch = chunk.audioUrl.match(/id=([a-zA-Z0-9_-]+)/);
      if (!fileIdMatch || !fileIdMatch[1]) {
        onPdfLoadError('Could not parse audio file ID.');
        return;
      }
      const fileId = fileIdMatch[1];

      google.script.run
        .withSuccessHandler(base64Data => {
          if (!base64Data) {
            onPdfLoadError('Failed to load audio data from server.');
            item.classList.remove('playing');
            currentlyPlayingChunk = null;
            return;
          }
          globalAudioPlayer.src = `data:audio/wav;base64,${base64Data}`;
          globalAudioPlayer.play();
        })
        .withFailureHandler(err => {
          onPdfLoadError(err);
          item.classList.remove('playing');
          currentlyPlayingChunk = null;
        })
        .getAudioDataAsBase64(fileId);
    }
    
    globalAudioPlayer.onended = () => {
      if (currentlyPlayingChunk) {
        const index = serverChunks.indexOf(currentlyPlayingChunk);
        const item = document.getElementById('chunk-item-' + index);
        if (item) {
          item.classList.remove('playing');
        }
      }
      currentlyPlayingChunk = null;
    };

    passwordInput.addEventListener('keypress', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        loadButton.click();
      }
    });

    emailInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            passwordInput.focus();
        }
    });

  </script>
</body>
</html>